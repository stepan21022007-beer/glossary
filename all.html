<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Глоссарий — Все термины</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-firestore-compat.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #333; }
    section { margin: 30px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background: white; }
    button { padding: 10px 20px; font-size: 16px; margin: 8px 0 0 0; cursor: pointer; border: none; border-radius: 4px; color: white; background: #6f42c1; }
    .term-item { border-bottom: 1px solid #eee; padding: 15px 0; }
    .term-item h3 { margin: 0 15px 8px 0; display: inline-block; color: #0056b3; }
    .delete-btn { background: #dc3545; padding: 6px 12px; font-size: 14px; color: white; border: none; cursor: pointer; border-radius: 4px; }
    #allTerms { margin-top: 20px; line-height: 1.6; }
    #status { color: #555; font-style: italic; margin: 10px 0; }
    nav { text-align: center; margin: 20px 0; }
    nav a { margin: 0 10px; color: #0056b3; text-decoration: none; }
    #error { color: red; font-weight: bold; margin: 15px 0; padding: 10px; background: #ffebee; border-radius: 4px; }
  </style>
</head>
<body>

  <h1>Глоссарий — Все термины по алфавиту</h1>

  <nav>
    <a href="./index.html">Поиск</a>
    <a href="./add.html">Добавить термин</a>
  </nav>

  <section>
    <button onclick="showAll()">Показать / обновить список</button>
    <div id="status">Нажмите кнопку, чтобы загрузить термины</div>
    <div id="allTerms"></div>
  </section>

  <div id="error"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGrlpsF9eTQvb7B2Ec29TnaD3Zl-VBjbs",
      authDomain: "my-glossary-55f58.firebaseapp.com",
      projectId: "my-glossary-55f58",
      storageBucket: "my-glossary-55f58.firebasestorage.app",
      messagingSenderId: "875015503393",
      appId: "1:875015503393:web:e8b19a0213be249275ad60"
    };

    // Проверяем, загрузился ли Firebase
    if (typeof firebase === 'undefined') {
      document.getElementById("error").textContent = "Firebase SDK не загрузился. Проверь интернет и перезагрузи страницу.";
      document.getElementById("status").textContent = "";
    } else {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const glossary = db.collection("glossary");

      const errorDiv = document.getElementById("error");
      const statusDiv = document.getElementById("status");

      function showAll() {
        errorDiv.textContent = "";
        statusDiv.textContent = "Загрузка терминов...";

        console.log("Запускаем загрузку терминов...");

        glossary.get()
          .then(snapshot => {
            console.log("Данные получены, количество документов:", snapshot.size);

            const container = document.getElementById("allTerms");
            container.innerHTML = "";

            if (snapshot.empty) {
              container.innerHTML = "<p>Глоссарий пока пуст. Добавьте термины на странице «Добавить термин».</p>";
              statusDiv.textContent = "Загружено 0 терминов";
              return;
            }

            const items = [];
            snapshot.forEach(doc => {
              items.push({ term: doc.id, def: doc.data().definition });
              console.log("Найден термин:", doc.id);
            });

            items.sort((a, b) => a.term.localeCompare(b.term, 'ru'));

            items.forEach(item => {
              const div = document.createElement("div");
              div.className = "term-item";
              div.innerHTML = `
                <h3>${item.term}</h3>
                <p>${item.def.replace(/\n/g, "<br>")}</p>
                <button class="delete-btn" onclick="deleteTerm('${item.term.replace(/'/g, "\\'")}')">Удалить</button>
              `;
              container.appendChild(div);
            });

            statusDiv.textContent = `Найдено терминов: ${items.length}`;
          })
          .catch(e => {
            console.error("Ошибка при загрузке:", e);
            errorDiv.textContent = "Ошибка загрузки: " + e.message + " (код: " + (e.code || "нет кода") + ")";
            statusDiv.textContent = "Не удалось загрузить термины";
          });
      }

      function deleteTerm(term) {
        if (!confirm(`Удалить "${term}"?`)) return;

        errorDiv.textContent = "";
        statusDiv.textContent = "Удаление...";

        glossary.doc(term).delete()
          .then(() => {
            alert("Термин удалён!");
            showAll();
          })
          .catch(e => {
            errorDiv.textContent = "Ошибка удаления: " + e.message;
            statusDiv.textContent = "";
          });
      }

      // Автозагрузка при открытии страницы
      window.onload = showAll;
    }
  </script>
</body>
</html>
